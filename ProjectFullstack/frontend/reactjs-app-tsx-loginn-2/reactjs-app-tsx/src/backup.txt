/*  ✅ ✅ ✅ ✅ App.tsx  ✅ ✅ ✅ ✅ */
import { BrowserRouter, Routes, Route, Link, NavLink } from 'react-router-dom';
import './App.css';
import AccountPage from './pages/account/AccountPage';
import DepartmentPage from './pages/department/DepartmentPage';
import LoginPage from './pages/LoginPage';
import { AuthProvider, useAuth } from './context/AuthContext';
import RequireAuth from './components/RequireAuth';

function AppContent() {
  const { user, logout } = useAuth();

  return (
    <BrowserRouter>
      <div className="App">

        {/* If logged in, display menu with navigation links  */}
        {user && (<ul>
          <li><Link to="/department">Department</Link></li>
          <li><Link to="/account">Account</Link></li>
        </ul>
        )}

        {/* If logged in, show user info and logout */}
        {user && (
          <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>
            <div>Welcome: : <strong>{user.fullName ?? user.username ?? user.email}</strong></div>
            <button className="btn btn-outline-secondary" onClick={() => logout()}>Logout</button>
          </div>
        )}

        {/* Routing */}
        <Routes>
          <Route path="/department" element={<RequireAuth><DepartmentPage /></RequireAuth>} />
          <Route path="/account" element={<RequireAuth><AccountPage /></RequireAuth>} />
          <Route path="/login" element={<LoginPage />} />
        </Routes>
      </div>
    </BrowserRouter>
  );
}

function App() {
  return (
    <AuthProvider>
      <AppContent />
    </AuthProvider>
  );
}

export default App;

/*  ✅ ✅ ✅ ✅ DepartmentPage.tsx  ✅ ✅ ✅ ✅ */
// impport css
import { Modal, ModalBody, ModalHeader, Table } from 'reactstrap';
import { Department } from '../../types/types';
import { useState, useEffect } from 'react';
import departmentService from '../../api/departmentService';

function DepartmentPage() {
    const [open, setOpen] = useState(false);
    const [departments, setDepartments] = useState<Department[]>();

    // form state
    const [name, setName] = useState('');
    const [totalMember, setTotalMember] = useState<number | ''>('');
    const [type, setType] = useState<'DEV' | 'TEST' | ''>('');
    const [editingId, setEditingId] = useState<number | null>(null);

    // load initial data using useEffect and departmentService
    async function fetchDepartments() {
        try {
            const data = await departmentService.getAllDepartments();
            setDepartments(data);
        } catch (error) {
            console.error('Failed to fetch departments:', error);
            // fallback to initial data
            setDepartments([]);
        }
    };

    useEffect(() => {
        fetchDepartments();
    }, []);

    function closeModal() {
        // reset form and editing state when modal closes
        setName('');
        setTotalMember('');
        setType('');
        setEditingId(null);
        setOpen(false);
    }

    function openForCreate() {
        setEditingId(null);
        setName('');
        setTotalMember('');
        setType('');
        setOpen(true);
    }

    function handleSubmit(e: React.FormEvent) {
        e.preventDefault();
        if (editingId != null) {
            // update existing

            // department object to update
            const updateDepartment: Department = {
                id: editingId,
                name: name || '',
                totalMember: Number(totalMember) || 0,
                type: type as 'DEV' | 'TEST' || 'DEV',
            };

            // call update department
            departmentService.updateDepartment(editingId, updateDepartment)
                .then(updatedDept => {
                    // c1: update local state
                    setDepartments(prev => prev ? prev.map(d => d.id === editingId ? updatedDept : d) : []);

                    // c2: call api get list again
                    // fetchDepartments()
                })
                .catch(error => {
                    console.error('Failed to update department:', error);
                });

            setEditingId(null);
        } else {
            // create new
            const newDept: Department = {
                name: name || 'New Department',
                totalMember: Number(totalMember) || 0,
                type: type as 'DEV' | 'TEST' || 'DEV',
                createDate: new Date().toISOString().slice(0, 10),
            };
            // call create department
            departmentService.createDepartment(newDept)
                .then(createdDept => {
                    // c1: update local state
                    setDepartments(prev => prev ? [...prev, createdDept] : [createdDept]);

                    // c2: call api get list again
                    // fetchDepartments()
                })
                .catch(error => {
                    console.error('Failed to create department:', error);
                });
        }

        // reset form & close modal
        setName('');
        setTotalMember('');
        setType('');
        setOpen(false);
    }

    function handleDelete(id: number) {
        if (window.confirm('Are you sure you want to delete this department?')) {
            // call delete department
            departmentService.deleteDepartment(id)
                .then(() => {
                    // C1: update local state after deletion to not call API again
                    setDepartments(prev => prev ? prev.filter(d => d.id !== id) : []);

                    // C2: call api get list again
                    // fetchDepartments();
                })
                .catch(error => {
                    console.error('Failed to delete department:', error);
                });
        }
    }

    function handleEdit(dep: Department) {
        setEditingId(dep.id ?? null);
        setName(dep.name);
        setTotalMember(dep.totalMember);
        setType(dep.type);
        setOpen(true);
    }

    if (!departments) {
        return <div>No data display...</div>;
    }


    return (
        <div className='container-fluid px-4'>

            <div className="container">
                <div className="table-wrapper">
                    <div className="table-title">
                        <div className="row">
                            <div className="col-sm-8">
                                <h2>Employee <b>View List</b></h2>
                            </div>
                            <div className="col-sm-4">
                                <button
                                    type="button"
                                    className="btn btn-info add-new"
                                    data-toggle="modal"
                                >
                                    <i className="fa fa-plus"></i> Add New
                                </button>
                            </div>
                        </div>
                    </div>
                    <table className="table table-bordered">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>John Doe</td>
                                <td>Administration</td>
                                <td>(171) 555-2222</td>
                                <td>
                                    <button className="btn btn-primary me-2" >Edit</button>
                                    <button className="btn btn-danger" >Delete</button>
                                </td>
                            </tr>
                            <tr>
                                <td>Peter Parker</td>
                                <td>Customer Service</td>
                                <td>(313) 555-5735</td>
                                <td>
                                    <a className="add" title="Add" data-toggle="tooltip"
                                    ><i className="material-icons">&#xE03B;</i></a
                                    >
                                    <a className="edit" title="Edit" data-toggle="tooltip"
                                    ><i className="material-icons">&#xE254;</i></a
                                    >
                                    <a className="delete" title="Delete" data-toggle="tooltip"
                                    ><i className="material-icons">&#xE872;</i></a
                                    >
                                </td>
                            </tr>
                            <tr>
                                <td>Fran Wilson</td>
                                <td>Human Resources</td>
                                <td>(503) 555-9931</td>
                                <td>
                                    <a className="add" title="Add" data-toggle="tooltip"
                                    ><i className="material-icons">&#xE03B;</i></a
                                    >
                                    <a className="edit" title="Edit" data-toggle="tooltip"
                                    ><i className="material-icons">&#xE254;</i></a
                                    >
                                    <a className="delete" title="Delete" data-toggle="tooltip"
                                    ><i className="material-icons">&#xE872;</i></a
                                    >
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                {/* <!-- Modal HTML --> */}
                <div id="myModal" className="modal fade" tabIndex={-1}>
                    <div className="modal-dialog">
                        <div className="modal-content">
                            {/* <!-- header --> */}
                            <div className="modal-header">
                                <h5 className="modal-title">Add Employee</h5>
                                <button type="button" className="close" data-dismiss="modal">
                                    &times;
                                </button>
                            </div>

                            {/* <!-- body --> */}
                            <div className="modal-body">
                                <div className="modal-container">
                                    <input type="hidden" id="id" name="id" />

                                    <label htmlFor="name"><b>Name</b></label>
                                    <input
                                        type="text"
                                        placeholder="Enter Name"
                                        name="name"
                                        id="name"
                                        required
                                    />

                                    <label htmlFor="department"><b>Department</b></label>
                                    <input
                                        type="text"
                                        placeholder="Enter Department"
                                        name="department"
                                        id="department"
                                        required
                                    />

                                    <label htmlFor="phone"><b>Phone</b></label>
                                    <input
                                        type="text"
                                        placeholder="Enter Phone"
                                        name="phone"
                                        id="phone"
                                        required
                                    />
                                </div>
                            </div>

                            {/* <!-- footer --> */}
                            <div className="modal-footer">
                                <button type="button" className="btn btn-secondary" data-dismiss="modal">
                                    Cancel
                                </button>
                                <button type="button" className="btn btn-primary" data-dismiss="modal" >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                {/* <!-- success alert --> */}
                <div className="alert alert-success" id="success-alert" style={{ display: 'none' }}>
                    <button type="button" className="close" data-dismiss="alert">x</button>
                    <strong>Success! </strong>
                </div>
            </div>
        </div>


    );
}

export default DepartmentPage;
